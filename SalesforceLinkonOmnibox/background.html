<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
<script>
  var c = chrome;
  var ws = c.windows;
  var tbs = c.tabs;
  var sgstObjArray = [];
  var sfUrl;
  
  //onInputChanged
  chrome.omnibox.onInputChanged.addListener(function(text, suggest) {
    ws.getCurrent(function(window) {
      tbs.getSelected(window.id, function(tab) {
        sfUrl = extractionSfUrl(tab);
        if(!isSfpage()) return false;
        var sgt = [];
        if(text.length > 0){
          $.each(sgstObjArray,function(i,v){
            if(v.content.indexOf(text) > -1){
              sgt.push(v);
            }
          });
        }
        suggest(sgt);
      });
    });
  });

  //onInputEntered
  chrome.omnibox.onInputEntered.addListener(function(text) {
    if(!isSfpage()) return false;
    if(text == ''){
      return;
    }
    
    var p;
    var inputArray = text.split(',');
    $.each(sgstObjArray,function(i,v){
      var idArray = v.content.split(',');
      for (var i=0; i < idArray.length; i++) {
        if(idArray[i] === inputArray[0]){
          p = v.url;
          return false;   
        }
      }
    });
    if (p !== undefined){
      navigate(sfUrl + p);
    }else{
      //id choose
      if(isSfId(text)){
        navigate(sfUrl +'/'+ text);
      }
    }
  });
  
  //onInputStarted
  chrome.omnibox.onInputStarted.addListener(function(){
    var jsonURL = 'OptionItems.json';
    $.getJSON(jsonURL, function(json){
      for (var i in json) {
          var sgstObj = {
            content     :json[i].id,
            description :json[i].name,
            url         :json[i].linkURL
          };
          sgstObjArray.push(sgstObj);  
      }
    });
    return sgstObjArray;
  });
  
  function navigate(url) {
    chrome.tabs.getSelected(null, function(tab) {
      chrome.tabs.update(tab.id, {url: url});
    });
  }

  function isSfpage() {
    return (sfUrl.indexOf('force.com') == -1 || sfUrl.indexOf('www.salesforce.com') > -1) ? false : true;
  }
  
  function extractionSfUrl(tab){
    var url = tab.url;
    var domain = url.split('/')[2];
    return 'https://' + domain;
  }
  
  function isSfId(text) {
    if(text.length == 15 || text.length == 18 
        ||((text.length == 17 || text.length == 20) 
          && (text.substr(-2) ==='/e'))){
      return true;
    }else{
      return false;
    }
  }
  
</script>
</head>
